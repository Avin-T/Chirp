import { Avatar, Card, Flex, Spinner, Text } from "@chakra-ui/react";
import {
	addDoc,
	collection,
	doc,
	orderBy,
	query,
	serverTimestamp,
	where,
} from "firebase/firestore";
import { useState } from "react";
import { useAuthState } from "react-firebase-hooks/auth";
import {
	useCollectionData,
	useDocumentData,
} from "react-firebase-hooks/firestore";
import { auth, db } from "../../../firebase";
import relationGenerator from "../helpers/relationGenerator";
import Divider from "./Divider";
import Footer from "./Footer";
import Messages from "./Messages";

interface ChatProps {
	reciever: string;
}

const Chat = ({ reciever }: ChatProps) => {
	// useAuthState is a react-firebase-hooks function that returns the current user that is logged in.
	const [currentUser] = useAuthState(auth);

	// useCollectionData is a react-firebase-hooks function that returns the data from the collection you pass in.

	// reciever is passed in from the ChatList component.

	// Here we are getting the chats collection where if the relation field is equal to the relation generated by the relationGenerator function(which sorts the ids of the users in alphabetical order).

	// We are also ordering the data by the createdAt field in descending order.
	const [values, loading, error] = useCollectionData(
		query(
			collection(db, "chats"),
			where(
				"relation",
				"==",
				relationGenerator(currentUser?.uid ?? "-", reciever)
			),
			orderBy("createdAt", "desc")
		),
		{
			snapshotListenOptions: { includeMetadataChanges: true },
		}
	);

	// useDocumentData is a react-firebase-hooks function that returns the data from the document you pass in.

	// Here we are getting the users collection where the id is equal to the reciever id.
	const [recieverValue, recieverLoading, recieverError] = useDocumentData(
		doc(db, "users", reciever ?? "-"),
		{
			snapshotListenOptions: { includeMetadataChanges: true },
		}
	);

	// useState hook is used to store the input message.
	const [inputMessage, setInputMessage] = useState("");

	// handleSendMessage function is used to add a new document to the chats collection.

	// if the current user send a message, the fromId field is equal to the current user id and the toId field is equal to the reciever id, and vice versa.

	// handleSendMessage function is called when the send button is clicked and updates the database if a message is entered with the inputMessage state containing all the details like the fromId, toId, text, createdAt, from, to and relation.

	const handleSendMessage = async () => {
		if (currentUser?.uid) {
			await addDoc(collection(db, "chats"), {
				fromId: currentUser?.uid,
				toId: reciever,
				text: inputMessage,
				createdAt: serverTimestamp(),
				from: doc(db, "users", currentUser?.uid),
				to: doc(db, "users", reciever),
				relation: relationGenerator(currentUser?.uid, reciever),
			});
		}
		if (inputMessage) {
			setInputMessage("");
		}
	};
	if (loading || recieverLoading) {
		return <Spinner />;
	}
	if (error || recieverError) {
		return <Spinner />;
	}

	return (
		<Flex
			as={Card}
			p="2"
			h="100vh"
			justify="center"
			align="center"
			position="fixed"
			top="0"
			right="0"
			borderLeftRadius="xl"
			maxWidth="xs"
		>
			<Flex w="100%" h="90%" flexDir="column">
				<Flex w="100%">
					<Flex flexDirection="row" mx="3" justify="center" alignItems="center">
						{/* If the reciever has a photoURL, then display the photoURL, else display a random image at the header of the chat box */}
						<Avatar mr="2" src={recieverValue?.photoURL} />

						{/* If the reciever has a displayName, then display the displayNameat the header of the chat box */}
						<Text fontSize="lg" fontWeight="bold">
							{recieverValue?.displayName}
						</Text>
					</Flex>
				</Flex>
				<Divider />

				{/* Passing the messages, currentUser, recieverValue to the Messages component */}
				<Messages
					messages={values as any}
					currentUser={currentUser}
					recieverValue={{
						photoURL: recieverValue?.photoURL,
						displayName: recieverValue?.displayName,
					}}
				/>
				<Divider />

				{/* Footer is the chat input field where the message is typed and submitted using the handleSendMessage component and the value of the input message is updated using the setInputMessage state */}
				<Footer
					inputMessage={inputMessage}
					setInputMessage={setInputMessage}
					handleSendMessage={handleSendMessage}
				/>
			</Flex>
		</Flex>
	);
};

export default Chat;
